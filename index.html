<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Surpresa de anivers√°rio do Guilherme." />
  <meta name="theme-color" content="#000000" />
  <title>Site Anivers√°rio Guilherme</title>

  <style>
    /* ============================================================
       1) FONTE PERSONALIZADA (Runic)
       ============================================================ */
    @font-face{
      font-family: "RunicMTCondensedLocal";
      src: url("./RunicMTCondensed.otf") format("opentype");
      font-display: swap;
    }

    /* ============================================================
       2) VARI√ÅVEIS GERAIS
       ============================================================ */
    :root{
      --runic: "RunicMTCondensedLocal", serif;
      --bg: #000;
      --text: #fff;

      --btn-bg: rgba(0,0,0,0.75);
      --btn-border: rgba(255,255,255,0.7);
      --btn-bg-hover: rgba(0,0,0,0.9);

      --shadow-strong: 0 20px 50px rgba(0,0,0,0.85);
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.65);

      --count-size-min: 80px;
      --count-size-max: 170px;

      --reveal-duration: 2100ms;
    }

    *{
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body{
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--runic);
      overflow: hidden;
    }

    body{
      position: relative;
    }

    /* ============================================================
       3) CAMADAS B√ÅSICAS
       ============================================================ */
    .layer{
      position: fixed;
      inset: 0;
    }

    .vignette{
      z-index: 1;
      pointer-events: none;
      background:
        radial-gradient(ellipse at center,
          rgba(0,0,0,0) 0%,
          rgba(0,0,0,0.35) 55%,
          rgba(0,0,0,0.96) 100%);
    }

    #confettiCanvas,
    #lightningCanvas{
      z-index: 8;
      pointer-events: none;
    }

    /* ============================================================
       4) TELA INICIAL (BOT√ÉO)
       ============================================================ */
    .stage{
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stage-inner{
      text-align: center;
      transform: translateY(40px);
    }

    .start-btn{
      padding: 20px 40px;
      font-size: 34px;
      font-weight: 900;
      border-radius: 18px;
      border: 2px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--text);
      cursor: pointer;
      box-shadow: var(--shadow-strong);
      letter-spacing: 1px;
      transition:
        transform .15s ease,
        background .15s ease,
        box-shadow .15s ease,
        border-color .15s ease;
    }

    .start-btn:hover{
      transform: scale(1.04);
      background: var(--btn-bg-hover);
      border-color: #ffffff;
      box-shadow: 0 26px 60px rgba(0,0,0,0.9);
    }

    .start-btn:active{
      transform: scale(0.97);
    }

    .start-btn[disabled]{
      opacity: 0.7;
      cursor: default;
      transform: none;
    }

    /* ============================================================
       5) CONTADOR (10 -> 0)
       ============================================================ */
    .countdown{
      position: fixed;
      z-index: 12;
      top: 56%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(var(--count-size-min), 14vw, var(--count-size-max));
      font-weight: 900;
      letter-spacing: 3px;
      text-shadow:
        0 0 12px rgba(0,0,0,0.7),
        0 18px 40px rgba(0,0,0,0.9);
      opacity: 0;
      transition: opacity .25s ease;
      pointer-events: none;
    }

    .countdown.show{
      opacity: 1;
    }

    /* ============================================================
       6) REVEAL DA IMAGEM
       ============================================================ */
    .reveal{
      z-index: 5;
      display: grid;
      place-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity .4s ease;
    }

    .reveal.active{
      opacity: 1;
      visibility: visible;
    }

    .reveal-frame{
      position: relative;
      width: 100vw;
      height: 100vh;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .reveal-bg{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: blur(20px) brightness(0.9);
      transform: scale(1.08);
      opacity: 0.85;
    }

    .reveal-main{
      position: relative;
      max-width: min(96vw, 1150px);
      max-height: min(88vh, 720px);
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 18px;
      box-shadow: 0 28px 70px rgba(0,0,0,0.9);
      transform-origin: center center;
      opacity: 0;
    }

    body.reveal-running .reveal-main{
      animation: spinZoom var(--reveal-duration) ease-out forwards;
    }

    @keyframes spinZoom{
      0%{
        transform: scale(0.05) rotate(0deg);
        opacity: 0;
      }
      20%{
        opacity: 1;
      }
      55%{
        transform: scale(0.5) rotate(360deg);
      }
      82%{
        transform: scale(0.9) rotate(640deg);
      }
      100%{
        transform: scale(1) rotate(720deg);
        opacity: 1;
      }
    }

    /* ============================================================
       7) TEXTOS + BOT√ÉO VAZIO
       ============================================================ */
    .messages-layer{
      position: fixed;
      inset: 0;
      z-index: 11;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .msgTop,
    .msgBottom,
    .merge-btn{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .45s ease, transform .45s ease;
    }

    body.show-messages .msgTop,
    body.show-messages .msgBottom,
    body.show-messages .merge-btn{
      opacity: 1;
      transform: translateY(0);
    }

    .msgTop{
      margin-bottom: auto;
      margin-top: 22px;
      font-size: clamp(24px, 3vw, 40px);
      font-weight: 900;
      color: #45b5ff;
      text-shadow:
        0 0 6px rgba(0,0,0,0.85),
        0 12px 30px rgba(0,0,0,0.9);
      white-space: nowrap;
    }

    .msgBottom{
      margin-top: auto;
      margin-bottom: 26px;
      font-size: clamp(20px, 2.4vw, 32px);
      font-weight: 900;
      color: #ff4b4b;
      text-shadow:
        0 0 6px rgba(0,0,0,0.85),
        0 12px 30px rgba(0,0,0,0.9);
      white-space: nowrap;
    }

    .merge-btn{
      pointer-events: auto;
      padding: 14px 32px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.6);
      background: linear-gradient(90deg,
        #ff3b3b 0%, #ff3b3b 50%,
        #2c7dff 50%, #2c7dff 100%);
      color: #fff;
      font-weight: 900;
      font-size: 26px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.65);
      cursor: pointer;
      margin-bottom: 32px;
      letter-spacing: 1px;
      transition:
        transform .15s ease,
        box-shadow .15s ease,
        opacity .2s ease;
    }

    .merge-btn:hover:not([disabled]){
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 18px 45px rgba(0,0,0,0.9);
    }

    .merge-btn:active:not([disabled]){
      transform: scale(0.98);
    }

    .merge-btn[disabled]{
      opacity: 0.75;
      cursor: default;
    }

    /* ============================================================
       8) FUS√ÉO + EXPLOS√ÉO
       ============================================================ */
    body.fusion .msgTop{
      animation: msgTopFuse 0.9s ease-in-out forwards;
    }

    body.fusion .msgBottom{
      animation: msgBottomFuse 0.9s ease-in-out forwards;
    }

    body.fusion .merge-btn{
      animation: mergeBtnFade 0.6s ease-out forwards;
    }

    @keyframes msgTopFuse{
      0%{
        transform: translateY(0);
        opacity: 1;
      }
      60%{
        transform: translateY(60px);
        opacity: 1;
      }
      100%{
        transform: translateY(120px);
        opacity: 0;
      }
    }

    @keyframes msgBottomFuse{
      0%{
        transform: translateY(0);
        opacity: 1;
      }
      60%{
        transform: translateY(-60px);
        opacity: 1;
      }
      100%{
        transform: translateY(-120px);
        opacity: 0;
      }
    }

    @keyframes mergeBtnFade{
      0%{
        transform: scale(1);
        opacity: 1;
      }
      100%{
        transform: scale(0.7);
        opacity: 0;
      }
    }

    .explosion{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 13;
      opacity: 0;
      pointer-events: none;
      mix-blend-mode: normal;
      background: #000;
      transition: opacity .30s ease;
    }

    .explosion.show{
      opacity: 1;
    }

    .explosion.fadeOut{
      opacity: 0;
    }

    /* ============================================================
       9) GALERIA
       ============================================================ */
    .gallery{
      position: fixed;
      inset: 0;
      z-index: 14;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 22px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .45s ease;
    }

    .gallery.active{
      opacity: 1;
      pointer-events: auto;
    }

    .gallery-main{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .gallery-image{
      max-width: min(96vw, 1250px);
      max-height: min(88vh, 760px);
      object-fit: contain;
      border-radius: 18px;
      box-shadow: 0 26px 70px rgba(0,0,0,0.9);
      background: rgba(0,0,0,0.25);
    }

    .gallery-video{
      max-width: min(96vw, 1250px);
      max-height: min(88vh, 760px);
      border-radius: 18px;
      box-shadow: 0 26px 70px rgba(0,0,0,0.9);
      background: #000;
      outline: none;
    }

    .image-author{
      font-size: 22px;
      font-weight: 800;
      color: #facc15;
      text-shadow:
        0 0 6px rgba(0,0,0,0.85),
        0 12px 30px rgba(0,0,0,0.9);
    }

    .gallery-nav{
      width: 58px;
      height: 58px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.65);
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 18px 48px rgba(0,0,0,0.85);
      transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
    }

    .gallery-nav:hover{
      background: rgba(0,0,0,0.95);
      transform: scale(1.08);
      box-shadow: 0 26px 70px rgba(0,0,0,0.95);
    }

    .gallery-nav:active{
      transform: scale(0.96);
    }

    .gallery-nav.hidden{
      display: none !important;
    }

    /* ============================================================
       9.1) PERGUNTA "VOC√ä ACEITA?"
       ============================================================ */
    .question{
      text-align: center;
    }

    .question-title{
      font-size: clamp(22px, 3vw, 32px);
      font-weight: 900;
      margin-bottom: 12px;
    }

    .answer-btn{
      display: block;
      margin: 6px auto;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.6);
      background: rgba(0,0,0,0.85);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.7);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .answer-btn:hover{
      transform: translateY(-1px) scale(1.02);
      background: rgba(0,0,0,0.95);
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
    }

    .answer1{
      color: #ff4444;
    }

    .answer2{
      color: #3b82ff;
    }

    .server-info{
      margin-top: 12px;
      font-size: 18px;
      font-weight: 800;
      color: #a855f7;
      text-shadow:
        0 0 6px rgba(0,0,0,0.85),
        0 12px 30px rgba(0,0,0,0.9);
      line-height: 1.4;
    }

    /* ============================================================
       10) CONFETES
       ============================================================ */
    body.confetti-on #confettiCanvas{
      opacity: 1;
    }

    #confettiCanvas{
      opacity: 0;
      transition: opacity .35s ease;
    }

    /* ============================================================
       11) RAIOS
       ============================================================ */
    #lightningCanvas{
      opacity: 0;
      transition: opacity .2s ease;
    }

    body.lightning-on #lightningCanvas{
      opacity: 1;
    }

    /* ============================================================
       12) DEBUG PANEL (LOG)
       ============================================================ */
    #debugPanel{
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: min(640px, 90vw);
      height: 220px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, Consolas, monospace;
      font-size: 11px;
      background: rgba(10,10,10,0.96);
      color: #33ff99;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.22);
      padding: 8px;
      resize: both;
      z-index: 999;
      display: none;
      white-space: pre;
      overflow: auto;
    }

    #debugPanel.open{
      display: block;
    }

    .hidden{
      display: none !important;
    }

    /* ============================================================
       13) MOBILE
       ============================================================ */
    @media(max-width: 520px){
      html, body{
        height: 100%;
        overflow-y: auto;
      }

      .stage-inner{
        transform: translateY(10px);
      }

      .start-btn{
        font-size: 26px;
        padding: 16px 24px;
      }

      .msgTop,
      .msgBottom{
        white-space: normal;
        text-align: center;
        padding: 0 10px;
      }

      .msgTop{
        font-size: 20px;
      }

      .msgBottom{
        font-size: 18px;
      }

      .merge-btn{
        font-size: 22px;
        padding: 12px 22px;
      }

      .image-author{
        font-size: 18px;
      }

      .gallery{
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 60px 10px 80px;
      }

      .gallery-main{
        width: 100%;
      }

      .gallery-image{
        max-height: 60vh;
      }

      .gallery-video{
        max-height: 60vh;
      }

      .gallery-nav{
        position: static;
        margin: 4px 0;
      }
    }
  </style>
</head>

<body>
  <div class="layer vignette"></div>

  <canvas id="confettiCanvas" class="layer"></canvas>
  <canvas id="lightningCanvas" class="layer"></canvas>

  <section id="reveal" class="layer reveal" aria-hidden="true">
    <div class="reveal-frame">
      <img src="./surpresa.png" alt="" class="reveal-bg" aria-hidden="true" />
      <img src="./surpresa.png" alt="Surpresa" class="reveal-main" id="revealMain" />
    </div>
  </section>

  <section class="messages-layer" aria-hidden="true">
    <div class="msgTop" id="msgTop">
      ü•≥ü•≥ü•≥FELIZ ANIVERS√ÅRIO GUILHERMEEEEEEE ü•≥ü•≥ü•≥!!!
    </div>

    <button id="mergeBtn" class="merge-btn" type="button">
      üî¥Vazioüíô...
    </button>

    <div class="msgBottom" id="msgBottom">
      üéäüéäüéä Que Jesus lhe aben√ßoe e lhe proteja sempre, que seu dia seja especial e venha muitos anos de vida meu querido amigo !!! ü´Çüò≠üôè
    </div>
  </section>

  <img
    src="./explosao.gif"
    alt="Explos√£o"
    id="explosionFx"
    class="explosion"
    loading="lazy"
  />

  <section id="gallery" class="gallery" aria-hidden="true">
    <button class="gallery-nav" id="galleryPrev" type="button" aria-label="Imagem anterior">‚Äπ</button>

    <div class="gallery-main">
      <img src="" alt="Mem√≥ria de anivers√°rio" id="galleryImage" class="gallery-image" />
      <video id="galleryVideo" class="gallery-video hidden" controls preload="metadata"></video>
      <p id="imageAuthor" class="image-author hidden"></p>

      <div id="questionSection" class="question hidden">
        <p class="question-title">Voc√™ aceita ? üòè</p>
        <button id="answer1Btn" class="answer-btn answer1" type="button">
          üååSim, entre o C√©u e a Terra, eu sou o mais honrado üåå
        </button>
        <button id="answer2Btn" class="answer-btn answer2" type="button">
          üî¥ üîµ Sim, eu sou o mais forte, o Sukuna √© buxa üü£
        </button>
        <p id="serverInfo" class="server-info hidden">
          Servidor :ReDarKin22-WnN7.aternos.me<br />
          Vers√£o do Minecraft Java : 1.21.11
        </p>
      </div>
    </div>

    <button class="gallery-nav" id="galleryNext" type="button" aria-label="Pr√≥xima imagem">‚Ä∫</button>
  </section>

  <main class="layer stage" id="stage">
    <div class="stage-inner">
      <button id="startBtn" class="start-btn" type="button">
        Come√ßar a Resenha? ...
      </button>
    </div>
  </main>

  <div id="countdown" class="countdown" aria-live="polite">10</div>

  <audio id="audioSombrio" loop preload="auto">
    <source src="./sombria.mp3" type="audio/mpeg" />
  </audio>

  <audio id="audioParabens" loop preload="auto">
    <source src="./feliz_aniversario.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // ============================================================
    // CONFIGURA√á√ÉO PRINCIPAL E CAMINHOS SEM ACENTO/ESPA√áO
    // - Pasta das m√≠dias:  "imagens_aniversario"
    // - Arquivos:          1.jpeg, 2.jpeg, ..., 13.mp4, 14.jpeg
    // - Lista de autores:  imagens_aniversario/autores.txt
    // ============================================================
    const startBtn       = document.getElementById("startBtn");
    const stage          = document.getElementById("stage");
    const countdownEl    = document.getElementById("countdown");
    const revealSection  = document.getElementById("reveal");
    const revealMainImg  = document.getElementById("revealMain");

    const msgTopEl       = document.getElementById("msgTop");
    const msgBottomEl    = document.getElementById("msgBottom");
    const mergeBtn       = document.getElementById("mergeBtn");

    const explosionEl    = document.getElementById("explosionFx");

    const galleryEl      = document.getElementById("gallery");
    const galleryImgEl   = document.getElementById("galleryImage");
    const galleryVideoEl = document.getElementById("galleryVideo");
    const galleryPrev    = document.getElementById("galleryPrev");
    const galleryNext    = document.getElementById("galleryNext");

    const questionSection= document.getElementById("questionSection");
    const answer1Btn     = document.getElementById("answer1Btn");
    const answer2Btn     = document.getElementById("answer2Btn");
    const serverInfo     = document.getElementById("serverInfo");
    const imageAuthorEl  = document.getElementById("imageAuthor");

    const confettiCanvas = document.getElementById("confettiCanvas");
    const lightningCanvas= document.getElementById("lightningCanvas");

    const audioSombrio   = document.getElementById("audioSombrio");
    const audioParabens  = document.getElementById("audioParabens");

    const CONFIG = {
      startCount: 10,
      tickMs: 1000,
      sombreVolume: 1.0,
      parabensVolume: 1.0,
      revealDurationMs: 2100,
      explosionVisibleMs: 6000
    };

    // pasta SEM acento/espa√ßo:
    const AUTHORS_FILE = "imagens_aniversario/autores.txt";
    let authorNames = [];
    let authorsLoaded = false;

    // ============================================================
    // REGRA NUM√âRICA DA GALERIA
    // ============================================================
    const MAX_MEDIA_NUMBER = 50;

    // cada item pode ter v√°rias varia√ß√µes de extens√£o (min√∫scula/MAI√öSCULA)
    const MEDIA_EXTENSIONS = [
      { type: "image", exts: ["png","PNG"] },
      { type: "image", exts: ["jpg","JPG","jpeg","JPEG","jfif","JFIF"] },
      { type: "image", exts: ["gif","GIF","webp","WEBP"] },
      { type: "video", exts: ["mp4","MP4","webm","WEBM","ogg","OGG"] }
    ];

    const galleryMedia  = [];

    let galleryReady = false;
    let galleryStartQueued = false;

    const STATE = {
      IDLE: "idle",
      COUNTDOWN: "countdown",
      REVEAL: "reveal",
      GALERY: "gallery"
    };

    let currentState = STATE.IDLE;
    let countdownTimer = null;
    let galleryIndex = 0;
    let questionMode = false;
    let lightningLoopStarted = false;

    const DEBUG = {
      buffer: [],
      panel: null,
      enabled: true
    };

    function debugLog(eventName, payload){
      if(!DEBUG.enabled) return;

      const t = performance.now();
      const ms = Math.round(t);
      let line = String(ms).padStart(4, " ") + "ms | " + eventName;

      if(payload !== undefined){
        try{
          line += " " + JSON.stringify(payload);
        }catch(e){
          line += " [payload-unstringifiable]";
        }
      }

      DEBUG.buffer.push(line);

      if(DEBUG.panel){
        DEBUG.panel.value = DEBUG.buffer.join("\n");
        DEBUG.panel.scrollTop = DEBUG.panel.scrollHeight;
      }
    }

    function attachDebugPanel(){
      let ta = document.getElementById("debugPanel");
      if(!ta){
        ta = document.createElement("textarea");
        ta.id = "debugPanel";
        ta.readOnly = true;
        ta.spellcheck = false;
        ta.wrap = "off";
        ta.placeholder = "Log (L abre/fecha, D baixa o arquivo .log)";
        document.body.appendChild(ta);
      }
      DEBUG.panel = ta;
    }

    function downloadLogFile(){
      if(!DEBUG.buffer.length) return;
      const blob = new Blob([DEBUG.buffer.join("\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const stamp = new Date().toISOString().replace(/[:.]/g, "-");
      a.href = url;
      a.download = "aniversario_guilherme_" + stamp + ".log";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function setupDebugKeys(){
      window.addEventListener("keydown", (ev) => {
        if(ev.key === "l" || ev.key === "L"){
          if(DEBUG.panel){
            DEBUG.panel.classList.toggle("open");
          }
        }else if(ev.key === "d" || ev.key === "D"){
          downloadLogFile();
        }
      });
    }

    function setState(st){
      currentState = st;
      debugLog("state_change", { state: st });
    }

    function safePlay(audio, volume){
      if(!audio) return;
      audio.volume = volume;
      audio.currentTime = 0;
      const playPromise = audio.play();
      if(playPromise && typeof playPromise.then === "function"){
        playPromise.then(() => {
          debugLog("audio_play_ok", { id: audio.id, volume });
        }).catch((err) => {
          debugLog("audio_play_blocked", {
            id: audio.id,
            name: err && err.name,
            message: err && err.message
          });
        });
      }
    }

    function safeStop(audio){
      if(!audio) return;
      try{ audio.pause(); }catch(e){}
      audio.currentTime = 0;
      debugLog("audio_stop", { id: audio.id });
    }

    function showCountdown(){
      countdownEl.classList.add("show");
    }

    function hideCountdown(){
      countdownEl.classList.remove("show");
    }

    function showReveal(){
      revealSection.classList.add("active");
      revealSection.setAttribute("aria-hidden", "false");
      document.body.classList.add("reveal-running");
      debugLog("reveal_shown");
    }

    function showMessages(){
      document.body.classList.add("show-messages");
      debugLog("messages_shown");
    }

    function hideStage(){
      if(stage){
        stage.style.display = "none";
        debugLog("stage_hidden");
      }
    }

    function showExplosion(){
      if(!explosionEl) return;
      explosionEl.classList.remove("fadeOut");
      explosionEl.classList.add("show");
      debugLog("explosion_show");
    }

    function hideExplosion(){
      if(!explosionEl) return;
      explosionEl.classList.add("fadeOut");
      debugLog("explosion_hide_start");
      setTimeout(() => {
        explosionEl.classList.remove("show", "fadeOut");
        debugLog("explosion_hide_done");
      }, 700);
    }

    function startRevealPhase(){
      setState(STATE.REVEAL);

      safeStop(audioSombrio);
      safePlay(audioParabens, CONFIG.parabensVolume);

      showReveal();
      startConfetti();
      startLightningLoop();

      setTimeout(() => {
        showMessages();
      }, CONFIG.revealDurationMs);

      debugLog("reveal_phase_start");
    }

    function startCountdown(){
      setState(STATE.COUNTDOWN);

      let n = CONFIG.startCount;
      countdownEl.textContent = n;
      showCountdown();
      debugLog("countdown_start", { start: n });

      if(countdownTimer) clearInterval(countdownTimer);

      countdownTimer = setInterval(() => {
        n--;
        countdownEl.textContent = n;
        debugLog("countdown_tick", { n });

        if(n <= 0){
          clearInterval(countdownTimer);
          countdownTimer = null;
          hideCountdown();
          debugLog("countdown_end", { n: 0 });
          startRevealPhase();
        }
      }, CONFIG.tickMs);
    }

    function startFusion(){
      if(!document.body.classList.contains("show-messages")) return;

      document.body.classList.add("fusion");
      mergeBtn.disabled = true;
      debugLog("fusion_start");

      showExplosion();

      setTimeout(() => {
        hideExplosion();
        document.body.classList.remove("show-messages");
        startGallery();
      }, CONFIG.explosionVisibleMs);
    }

    function startGallery(){
      if(!galleryReady){
        galleryStartQueued = true;
        debugLog("gallery_wait_ready");
        return;
      }

      if(!galleryMedia || !galleryMedia.length){
        debugLog("gallery_no_media");
        return;
      }

      setState(STATE.GALERY);

      if(galleryEl){
        galleryEl.classList.add("active");
        galleryEl.setAttribute("aria-hidden", "false");
      }

      debugLog("gallery_start", { total: galleryMedia.length });
      showGalleryImage(0);
    }

    function hideQuestion(){
      questionMode = false;
      if(questionSection){
        questionSection.classList.add("hidden");
      }
      if(galleryImgEl){
        galleryImgEl.classList.remove("hidden");
      }
      if(galleryVideoEl){
        galleryVideoEl.classList.remove("hidden");
      }
      if(serverInfo){
        serverInfo.classList.add("hidden");
      }
      if(imageAuthorEl){
        imageAuthorEl.classList.remove("hidden");
      }
      if(galleryNext && galleryMedia.length > 1){
        galleryNext.classList.remove("hidden");
      }
      debugLog("question_hide");
    }

    function showQuestion(){
      questionMode = true;
      if(galleryImgEl){
        galleryImgEl.classList.add("hidden");
      }
      if(galleryVideoEl){
        galleryVideoEl.classList.add("hidden");
      }
      if(imageAuthorEl){
        imageAuthorEl.classList.add("hidden");
      }
      if(questionSection){
        questionSection.classList.remove("hidden");
      }
      if(galleryNext){
        galleryNext.classList.add("hidden");
      }
      debugLog("question_show");
    }

    // ============================================================
    // AUTOR DA M√çDIA (POR N√öMERO DO ARQUIVO)
    // ============================================================
    function updateAuthorForCurrentImage(){
      if(!imageAuthorEl){
        return;
      }
      if(!authorsLoaded){
        imageAuthorEl.textContent = "";
        imageAuthorEl.classList.add("hidden");
        return;
      }

      const currentItem = galleryMedia[galleryIndex];
      if(!currentItem || typeof currentItem.number !== "number"){
        imageAuthorEl.textContent = "";
        imageAuthorEl.classList.add("hidden");
        debugLog("author_no_item", { galleryIndex });
        return;
      }

      const mediaNumber = currentItem.number;
      const authorIndex = mediaNumber - 1;

      const nameRaw = authorNames[authorIndex];
      const name = nameRaw ? String(nameRaw).trim() : "";

      if(name){
        imageAuthorEl.textContent = name;
        imageAuthorEl.classList.remove("hidden");
        debugLog("author_set", { galleryIndex, mediaNumber, authorIndex, name });
      }else{
        imageAuthorEl.textContent = "";
        imageAuthorEl.classList.add("hidden");
        debugLog("author_empty", { galleryIndex, mediaNumber, authorIndex });
      }
    }

    function showGalleryItem(index){
      if(!galleryMedia || !galleryMedia.length) return;
      if(!galleryImgEl || !galleryVideoEl) return;

      hideQuestion();

      if(index < 0 || index >= galleryMedia.length){
        return;
      }

      galleryIndex = index;
      const item = galleryMedia[galleryIndex];

      galleryImgEl.classList.add("hidden");
      galleryVideoEl.classList.add("hidden");

      try{
        galleryVideoEl.pause();
      }catch(e){
        debugLog("video_pause_error", { message: e && e.message });
      }

      if(item.type === "image"){
        galleryImgEl.src = item.src;
        galleryImgEl.alt = `Mem√≥ria de anivers√°rio - imagem ${item.number}`;
        galleryImgEl.classList.remove("hidden");
        debugLog("gallery_image", { index: galleryIndex, src: item.src, number: item.number });
      }else if(item.type === "video"){
        galleryVideoEl.src = item.src;
        galleryVideoEl.classList.remove("hidden");
        galleryVideoEl.setAttribute("playsinline", "playsinline");
        galleryVideoEl.setAttribute("controls", "controls");
        galleryVideoEl.alt = `Mem√≥ria de anivers√°rio - v√≠deo ${item.number}`;
        debugLog("gallery_video", { index: galleryIndex, src: item.src, number: item.number });
        const playPromise = galleryVideoEl.play();
        if(playPromise && typeof playPromise.then === "function"){
          playPromise.then(() => {
            debugLog("gallery_video_play_ok", { index: galleryIndex });
          }).catch((err) => {
            debugLog("gallery_video_play_blocked", {
              index: galleryIndex,
              name: err && err.name,
              message: err && err.message
            });
          });
        }
      }

      updateAuthorForCurrentImage();

      if(galleryPrev && galleryNext){
        if(galleryMedia.length <= 1){
          galleryPrev.classList.add("hidden");
          galleryNext.classList.add("hidden");
        }else{
          if(galleryIndex <= 0){
            galleryPrev.classList.add("hidden");
          }else{
            galleryPrev.classList.remove("hidden");
          }

          if(galleryIndex >= galleryMedia.length - 1){
            galleryNext.classList.remove("hidden");
          }else{
            galleryNext.classList.remove("hidden");
          }
        }
      }
    }

    function showGalleryImage(index){
      showGalleryItem(index);
    }

    // ============================================================
    // GALERIA EM ORDEM NUM√âRICA (TENTA V√ÅRIAS EXTENS√ïES)
    // ============================================================
    function buildGalleryList(){
      const foundMedia = [];
      let pendingChecks = 0;

      function registerResult(number, type, src){
        foundMedia.push({ number, type, src });
        debugLog("media_found", { number, type, src });
      }

      function checkDone(){
        pendingChecks--;
        if(pendingChecks <= 0){
          foundMedia.sort((a, b) => a.number - b.number);
          foundMedia.forEach((item) => {
            galleryMedia.push({
              type: item.type,
              src:  item.src,
              number: item.number
            });
          });

          galleryReady = true;
          debugLog("gallery_scan_done_numeric", {
            totalMedia: galleryMedia.length,
            lastNumberChecked: MAX_MEDIA_NUMBER
          });

          if(galleryStartQueued){
            galleryStartQueued = false;
            startGallery();
          }
        }
      }

      if(MAX_MEDIA_NUMBER <= 0){
        galleryReady = true;
        debugLog("gallery_no_numbers_configured");
        return;
      }

      for(let num = 1; num <= MAX_MEDIA_NUMBER; num++){
        let mediaFoundForThisNumber = false;

        MEDIA_EXTENSIONS.forEach((def) => {
          if(mediaFoundForThisNumber) return;

          def.exts.forEach((ext) => {
            if(mediaFoundForThisNumber) return;

            // pasta SEM acento/espa√ßo:
            const src = `imagens_aniversario/${num}.${ext}`;
            pendingChecks++;

            if(def.type === "image"){
              const img = new Image();
              img.onload = () => {
                if(!mediaFoundForThisNumber){
                  mediaFoundForThisNumber = true;
                  registerResult(num, "image", src);
                }
                checkDone();
              };
              img.onerror = () => {
                debugLog("media_error", { number: num, type: "image", src });
                checkDone();
              };
              img.src = src;
            }else if(def.type === "video"){
              const videoProbe = document.createElement("video");
              videoProbe.onloadeddata = () => {
                if(!mediaFoundForThisNumber){
                  mediaFoundForThisNumber = true;
                  registerResult(num, "video", src);
                }
                checkDone();
              };
              videoProbe.onerror = () => {
                debugLog("media_error", { number: num, type: "video", src });
                checkDone();
              };
              videoProbe.src = src;
              videoProbe.load();
            }else{
              debugLog("media_type_unknown", { number: num, def });
              checkDone();
            }
          });
        });
      }

      if(pendingChecks === 0){
        galleryReady = true;
        debugLog("gallery_no_candidates_to_check");
      }
    }

    function loadAuthorList(){
      fetch(AUTHORS_FILE)
        .then((resp) => {
          if(!resp.ok){
            throw new Error("HTTP " + resp.status);
          }
          return resp.text();
        })
        .then((text) => {
          authorNames = text.split(/\r?\n/);
          authorsLoaded = true;
          debugLog("authors_loaded", { total: authorNames.length });

          if(currentState === STATE.GALERY && galleryMedia.length > 0){
            updateAuthorForCurrentImage();
          }
        })
        .catch((err) => {
          authorsLoaded = false;
          debugLog("authors_load_fail", {
            file: AUTHORS_FILE,
            name: err && err.name,
            message: err && err.message
          });
        });
    }

    const confettiCtx = confettiCanvas.getContext("2d");
    let confettiPieces = [];
    let confettiRunning = false;

    function resizeConfetti(){
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
    resizeConfetti();

    function spawnConfetti(count){
      for(let i = 0; i < count; i++){
        confettiPieces.push({
          x: Math.random() * confettiCanvas.width,
          y: Math.random() * confettiCanvas.height,
          vy: 1 + Math.random() * 3,
          vx: (Math.random() - 0.5) * 1.2,
          size: 4 + Math.random() * 4,
          color: `hsl(${Math.random() * 360}, 100%, 60%)`
        });
      }
    }

    function confettiLoop(){
      if(!confettiRunning) return;

      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

      for(const p of confettiPieces){
        p.y += p.vy;
        p.x += p.vx;

        if(p.y > confettiCanvas.height + 8) p.y = -8;
        if(p.x < -8) p.x = confettiCanvas.width + 8;
        if(p.x > confettiCanvas.width + 8) p.x = -8;

        confettiCtx.fillStyle = p.color;
        confettiCtx.fillRect(p.x, p.y, p.size, p.size * 0.7);
      }

      requestAnimationFrame(confettiLoop);
    }

    function startConfetti(){
      if(confettiRunning) return;
      confettiRunning = true;
      document.body.classList.add("confetti-on");
      spawnConfetti(280);
      debugLog("confetti_start", { pieces: confettiPieces.length });
      confettiLoop();
    }

    const lightningCtx = lightningCanvas.getContext("2d");

    function resizeLightning(){
      lightningCanvas.width = window.innerWidth;
      lightningCanvas.height = window.innerHeight;
    }
    resizeLightning();

    function rand(min, max){
      return Math.random() * (max - min) + min;
    }

    function drawBolt(){
      lightningCtx.clearRect(0, 0, lightningCanvas.width, lightningCanvas.height);

      const startX = rand(lightningCanvas.width * 0.2, lightningCanvas.width * 0.8);
      let x = startX;
      let y = 0;

      lightningCtx.beginPath();
      lightningCtx.moveTo(x, y);

      const step = 18;
      while(y < lightningCanvas.height){
        x += rand(-20, 20);
        y += step;
        lightningCtx.lineTo(x, y);
      }

      lightningCtx.strokeStyle = "rgba(180,220,255,0.95)";
      lightningCtx.lineWidth = 2.4;
      lightningCtx.shadowBlur = 18;
      lightningCtx.shadowColor = "rgba(120,190,255,1)";
      lightningCtx.stroke();

      setTimeout(() => {
        lightningCtx.clearRect(0, 0, lightningCanvas.width, lightningCanvas.height);
      }, 120);
    }

    function startLightningLoop(){
      if(lightningLoopStarted) return;
      lightningLoopStarted = true;
      document.body.classList.add("lightning-on");
      debugLog("lightning_loop_start");
      setInterval(() => {
        if(currentState === STATE.REVEAL || currentState === STATE.GALERY){
          drawBolt();
        }
      }, 400);
    }

    window.addEventListener("resize", () => {
      resizeConfetti();
      resizeLightning();
      debugLog("resize", { w: window.innerWidth, h: window.innerHeight });
    });

    window.addEventListener("load", () => {
      attachDebugPanel();
      setupDebugKeys();

      const reducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      debugLog("window_load", {
        ua: navigator.userAgent,
        viewport: { w: window.innerWidth, h: window.innerHeight },
        reducedMotion
      });

      buildGalleryList();
      loadAuthorList();

      setState(STATE.IDLE);
      safePlay(audioSombrio, CONFIG.sombreVolume);
    });

    startBtn.addEventListener("click", () => {
      if(currentState !== STATE.IDLE) return;

      debugLog("start_click");
      hideStage();

      if(audioSombrio.paused){
        safePlay(audioSombrio, CONFIG.sombreVolume);
      }

      startCountdown();
    });

    mergeBtn.addEventListener("click", () => {
      debugLog("merge_click");
      startFusion();
    });

    if(galleryPrev){
      galleryPrev.addEventListener("click", () => {
        if(questionMode){
          hideQuestion();
        }
        showGalleryImage(galleryIndex - 1);
      });
    }

    if(galleryNext){
      galleryNext.addEventListener("click", () => {
        if(!galleryMedia || !galleryMedia.length) return;

        if(questionMode){
          return;
        }

        if(galleryIndex >= galleryMedia.length - 1){
          showQuestion();
        }else{
          showGalleryImage(galleryIndex + 1);
        }
      });
    }

    if(answer1Btn){
      answer1Btn.addEventListener("click", () => {
        debugLog("answer1_click");
        if(serverInfo){
          serverInfo.classList.remove("hidden");
        }
      });
    }

    if(answer2Btn){
      answer2Btn.addEventListener("click", () => {
        debugLog("answer2_click");
        if(serverInfo){
          serverInfo.classList.remove("hidden");
        }
      });
    }
  </script>

  <!--
    ANOTA√á√ÉO EXTRA: autores.txt
    - linha 0  -> arquivo "1.*"
    - linha 1  -> arquivo "2.*"
    - linha 2  -> arquivo "3.*"
    - ...
    O c√≥digo usa o N√öMERO da m√≠dia (item.number) para buscar o autor:
    authorNames[item.number - 1].

    IMPORTANTE: a pasta das m√≠dias agora se chama "imagens_aniversario"
    (sem acento e sem espa√ßo), para evitar problema em servidor Linux /
    GitHub Pages com codifica√ß√£o de caracteres.
  -->

  <!-- linhas extras de carinho pro Guilherme -->
  <!-- linha extra de carinho #1 para o Guilherme -->
  <!-- linha extra de carinho #2 para o Guilherme -->
  <!-- linha extra de carinho #3 para o Guilherme -->
  <!-- linha extra de carinho #4 para o Guilherme (com v√≠deos, jpeg/jpg/png e tudo alinhado!) -->
  <!-- linha extra de carinho #5 para o Guilherme (main organizada e sem acento nos caminhos!) -->
</body>
</html>